#!/usr/bin/env bash
## Wrapper for downloading and extracting import library from mpg123 binary release
## If no params provided, use 1.25.13
## winstall-mpg123[<target-platform>] [<binary-url> <binary-hash>]
set -eu
set -o pipefail

function winstall_mpg123 {
    local target_platform="${1:-x64}"
    local binary_url="${2:-http://mpg123.de/download/win64/1.25.13/mpg123-1.25.13-x86-64.zip}"
    local binary_hash="${3:-809e847de9169e63b65d1593d163977c2fca5a65}"

    local temp_dir=
    temp_dir=$( mktemp -d )
    trap "> /dev/null 2>&1 rm -rf '${temp_dir}' || true" EXIT

    local this_dir=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )

    local binary_archive=
    binary_archive=$( "${this_dir}/safe-download" "${binary_url}" "${temp_dir}" "${binary_hash}" )

    local install_dir=
    install_dir=$( "${this_dir}/get-windows-program-files-dir" "${target_platform}" )
    >&2 unzip "${binary_archive}" -d "${install_dir}"

    local subdir="${binary_url%.zip}"
    subdir="${subdir##*/}"

    for f in "${install_dir}/${subdir}"/*.dll; do
        "${this_dir}/dll2lib" "${f}" "${target_platform}"
    done
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    winstall_mpg123 "$@"
fi
