#!/usr/bin/env bash
## Wrapper for libsndfile installer for Windows
## winstall-libsndfile <installer-url> <installer-hash>
set -eu
set -o pipefail

function winstall_libsndfile {
    local target_platform="${1:-x64}"
    local url="${2:-http://www.mega-nerd.com/libsndfile/files/libsndfile-1.0.28-w64-setup.exe}"
    local hash="${3:-3783e513d735d1526f19a32a63991026}"
    local this_dir=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
    local temp_dir=
    temp_dir=$( mktemp -d )
    trap "> /dev/null 2>&1 rm -rf '${temp_dir}' || true" EXIT

    local install_dir=
    install_dir=$( "${this_dir}/get-windows-program-files-dir" "${target_platform}" )
    install_dir+="/Mega-Nerd/libsndfile"

    local installer_file=
    installer_file=$( "${this_dir}/safe-download" "${url}" "${temp_dir}" "${hash}" )
    # HACK: installer shows modal dialog box from subprocess sndfile-about.exe asking to donate
    # (thank you, Erik de Castro Lopo, this is great for CI), but this is Windows
    # native process and we can't get its pid (tasklist shows truncated commands so it doesn't help).
    # Just wait a bit and kill the parent.
    # TODO: do it properly one day
    MSYS_NO_PATHCONV=1 "${installer_file}" /VERYSILENT &
    local pid=$!
    while [[ ! -f "${install_dir}/include/sndfile.h"
            || ! -f "${install_dir}/bin/libsndfile-1.dll"
            || ! -f "${install_dir}/lib/libsndfile-1.lib" ]]; do
        sleep 1
    done
    kill "${pid}"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    winstall_libsndfile "$@"
fi
