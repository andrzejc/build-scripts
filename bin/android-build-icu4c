#! /usr/bin/env bash
# Based on https://gist.github.com/DanielSerdyukov/188d47e29150622352f1 with fixes
set -e -o pipefail
set +x
# optional dependencies:
THIS_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
SOURCE_URL="${SOURCE_URL:-https://github.com/unicode-org/icu/releases/download/release-68-2/icu4c-68_2-src.tgz}"
wget -c -nv "${SOURCE_URL}"

TARBALL="${SOURCE_URL##*/}"
STEM="${TARBALL%%-src.t*}"
tar xf "${TARBALL}"

if [[ -n "${BUILD_DATA:-}" ]]
then
    DATA_URL="${SOURCE_URL%/*}/${STEM}-data.zip"
    wget -c -nv "${DATA_URL}"
    mv icu/source/data icu/source/data.orig
    unzip "${STEM}-data.zip" -d icu/source
fi

export CFLAGS="${CFLAGS:-} -Os"
export CXXFLAGS="${CXXFLAGS:-} --std=c++11"

pushd icu
echo "*" > .gitignore
mkdir -p linux
pushd linux
../source/runConfigureICU Linux --prefix="${PWD}/prebuilt" \
    --enable-static \
    --enable-shared=no \
    --enable-extras=no \
    --enable-strict=no \
    --enable-icuio=no \
    --enable-layout=no \
    --enable-layoutex=no \
    --enable-tools=yes \
    --enable-tests=no \
    --enable-samples=no \
    --enable-dyload=no
make -j8
popd

CROSS_BUILD_DIR=$(realpath linux)
INSTALL_DIR="${INSTALL_DIR:-${HOME}/android-deps}"
INSTALL_SUBDIR="${INSTALL_DIR}/${STEM}"

function build_single_target {
    export CFLAGS="-Os -fPIC"
    export CXXFLAGS="--std=c++11 -fPIC"
    export -n LDFLAGS
    source "${THIS_DIR}/android-setup-toolchain.sh"
    mkdir -p "${ABI}"
    pushd "${ABI}"
    ../source/configure --prefix="${INSTALL_SUBDIR}/${ABI}" \
        --host="${TARGET}" \
        --enable-static \
        --enable-shared=no \
        --enable-extras=no \
        --enable-strict=no \
        --enable-icuio=no \
        --enable-layout=no \
        --enable-layoutex=no \
        --enable-tools=no \
        --enable-tests=no \
        --enable-samples=no \
        --enable-dyload=no \
        --with-cross-build="${CROSS_BUILD_DIR}" \
        --with-data-packaging=static
    make -j8 install
    popd
}

rm -rf "${INSTALL_SUBDIR}"
TARGETS="${TARGETS:-armv7a-linux-androideabi aarch64-linux-android i686-linux-android x86_64-linux-android}"
for TARGET in ${TARGETS}
do
    build_single_target "$@"
done
pushd "${INSTALL_DIR}"
rm -rf "${STEM}.tar.bz2"
tar -chaf "${STEM}.tar.bz2" "${STEM}"
popd