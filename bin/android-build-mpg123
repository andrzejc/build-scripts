#! /usr/bin/env bash
set -e -o pipefail
set +x

THIS_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
MPG123_SOURCE_URL="${MPG123_SOURCE_URL:-https://sourceforge.net/projects/mpg123/files/mpg123/1.26.4/mpg123-1.26.4.tar.bz2}"
wget -nv "${MPG123_SOURCE_URL}"

MPG123_TGZ="${MPG123_SOURCE_URL##*/}"
MPG123_STEM="${MPG123_TGZ%%.tar*}"
INSTALL_DIR="${INSTALL_DIR:-${HOME}/android-deps}"
INSTALL_SUBDIR="${INSTALL_DIR}/${MPG123_STEM}"

tar xf "${MPG123_TGZ}"

function build_single_target {
    export CFLAGS=
    export CXXFLAGS=
    source "${THIS_DIR}/android-setup-toolchain.sh"
    local opts
    case "${TARGET}" in
    armv7a-*)
        opts+=(--with-cpu=arm_fpu)
        ;;
    aarch64=*)
        opts+=(--with-cpu=aarch64)
        ;;
    i686-*)
        opts+=(--with-cpu=generic_fpu)
        # XXX CPU x86 produces non-relocatable assembler output, to be investigated
        # opts+=(--with-cpu=x86)
        ;;
    x86_64-*)
        opts+=(--with-cpu=x86-64)
        ;;
    esac
    ./configure \
        --prefix="${INSTALL_SUBDIR}/${ABI}" \
        --host="${TARGET}" \
        --enable-modules=no \
        --enable-static \
        --enable-shared=no \
        --with-default-audio=dummy \
        --with-pic \
        "${opts[@]}" \
        "$@"
    make -j8 install
    make distclean
}


pushd "${MPG123_STEM}"
echo "*" > .gitignore
TARGETS=(armv7a-linux-androideabi aarch64-linux-android i686-linux-android x86_64-linux-android)
for target in "${TARGETS[@]}"
do
    TARGET="${target}" build_single_target "$@"
done
popd
pushd "${INSTALL_DIR}"
tar -chaf "${MPG123_STEM}.tar.bz2" "${MPG123_STEM}"
popd
