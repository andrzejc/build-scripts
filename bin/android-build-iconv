#! /usr/bin/env bash
set -e -o pipefail
set +x

THIS_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
ICONV_SOURCE_URL="${ICONV_SOURCE_URL:-https://ftp.gnu.org/pub/gnu/libiconv/libiconv-1.16.tar.gz}"
wget -nv "${ICONV_SOURCE_URL}"

ICONV_TGZ="${ICONV_SOURCE_URL##*/}"
ICONV_STEM="${ICONV_TGZ%%.tar*}"
INSTALL_DIR="${INSTALL_DIR:-${HOME}/android-deps}"
INSTALL_SUBDIR="${INSTALL_DIR}/${ICONV_STEM}"

tar xf "${ICONV_TGZ}"

function build_single_target {
    export CFLAGS=
    export CXXFLAGS=
    source "${THIS_DIR}/android-setup-toolchain.sh"
    ./configure \
        --prefix="${INSTALL_SUBDIR}/${ABI}" \
        --host="${TARGET}" \
        --enable-static \
        --enable-shared=no \
        --with-pic \
        "$@"
    make -j8 install
    make distclean
}


pushd "${ICONV_STEM}"
echo "*" > .gitignore
TARGETS=(armv7a-linux-androideabi aarch64-linux-android i686-linux-android x86_64-linux-android)
for target in "${TARGETS[@]}"
do
    TARGET="${target}" build_single_target "$@"
done
popd
pushd "${INSTALL_DIR}"
tar -chaf "${ICONV_STEM}.tar.bz2" "${ICONV_STEM}"
popd
